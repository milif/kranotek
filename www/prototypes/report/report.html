<!DOCTYPE html>
<html>
  <head>
    <title>Prototype</title>
    <meta charset="utf-8">
    <!-- Bootstrap -->
    <link href="../../vendor/bootstrap/css/bootstrap.css" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="../../vendor/bootstrap/css/bootstrap-responsive.css" rel="stylesheet">  
        
    
    
  </head>
  <body style="background: url(../background.png); ">
  
    <div class="container-fluid">
        <h1>Diagram</h1>
        <div id="diagram" style="background: white;"></div>             
    </div>
    
    <style>
        h1 .btn {
            margin-left: 15px;
            }
    </style>    
    
    <script id="require" type="text/javascript" src="../../require.js"></script>
    <script>
        require('loader.js', function(){
            require(
                'CollectionNested.js',
                'view/Diagram.js',   
                'view/Dropdown.js',
                'view/Grid.js',
                'view/toolbar/Toolbar.js',
                'view/button/Button.js',
                'modules/report/collection.Report.js',
                'modules/report/view.FormReport.js',
                
                function(){
                
                    App.env = {
                        apiUrl: '/app_dev.php',
                        apiUrlSuffix: ''
                    }

                    var Grid = App.getView('Grid'),
                        Button = App.getView('Button'),
                        Toolbar = App.getView('Toolbar'),
                        ModelReport = App.getModel('Report'),
                        collection = new(App.getCollection('Report'))([{
                           "Name":"testname",
                           "Config":[
                              {
                                 "Name":"RootData",
                                 "Data":"",
                                 "path":"/node46",
                                 "moveable":true
                              },
                              {
                                 "Name":"Data1",
                                 "Data":{
                                    "Name":"test",
                                    "FunctionId":"567",
                                    "Type":"Table",
                                    "Config":[
                                       {
                                          "title":"test",
                                          "fieldName":"testfjgjt",
                                          "columnWidth":"100",
                                          "isVisible":false
                                       },
                                       {
                                          "title":"oklopot",
                                          "fieldName":"yttgb",
                                          "columnWidth":"",
                                          "isVisible":true
                                       }
                                    ],
                                    "id":12,
                                    "path":"/11505/12",
                                    "leaf":true
                                 },
                                 "path":"/node46/node63",
                                 "moveable":true
                              },
                              {
                                 "Name":"Data2",
                                 "Data":"",
                                 "path":"/node46/node76",
                                 "moveable":true
                              },
                              {
                                 "Name":"Menu1Sub1",
                                 "Data":"",
                                 "path":"/node46/node89",
                                 "moveable":true,
                                 "scheme":"yellow"
                              },
                              {
                                 "Name":"Menu1Sub1Sub",
                                 "Data":"",
                                 "path":"/node46/node89/node106",
                                 "moveable":true,
                                 "scheme":"yellow"
                              }
                           ]
                        },{
                           "Name":"testname2",
                           "Config":[
                              {
                                 "Name":"RootData2",
                                 "Data":"",
                                 "path":"/node2",
                                 "moveable":true
                              }
                            ]
                        }]),
                        report = new ModelReport({}),
                        addButton = new Button({
                            tooltip: 'Добавить представление',
                            size: 'small',
                            icon: 'icon-plus',
                            click: function(){
                                formReport.setModel(new ModelReport({}));
                                formReport.show();
                            }
                        }),
                        editButton = new Button({
                            disabled: true,
                            size: 'small',
                            icon: 'icon-edit',
                            click: function(){
                                var ids = grid.getSelection(),
                                    model = collection.get(ids[0]);
                                formReport.setModel(model);
                                formReport.show();
                            }
                        }), 
                        removeButton = new Button({
                            disabled: true,
                            size: 'small',
                            icon: 'icon-remove',
                            click: function(){
                                var ids = grid.getSelection(),
                                    model = collection.get(ids[0]);
                                collection.remove([model], {silent: false});
                            }
                        }),
                        grid = new Grid({
                            collection: collection,
                            selectable: true,
                            columns: [
                                { key: 'Name', name: 'Название' }
                            ],
                            listeners: {
                                'selectionchange': function(id){
                                    var model = collection.get(id);
                                    if(model) {
                                        removeButton.enable();
                                        editButton.enable();
                                        formReport.setModel(model);
                                        formReport.show();
                                    } else {
                                        removeButton.disable();
                                        editButton.disable();
                                        formReport.hide();
                                    }
                                }
                            }
                        });
                        FormReport = App.getView('FormReport'),
                        formReport = new FormReport({
                            model: report
                        });

                    formReport.hide();

                    grid.getToolbar()
                      .add(addButton, 1)
                      .add(editButton, 2)
                      .add(removeButton, 2);
                    
                    $('#diagram').append(grid.$el);
                    $('#diagram').append(formReport.$el);

                    grid.layout();
                
                }
            );
        });    
    </script>

  </body>
</html>
